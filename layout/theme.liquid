{% assign header_content = content_for_header | handleize %}

<!doctype html>
<html class="no-js template-{{ template.name }}{% if request.design_mode %} theme-editor{% endif %}" lang="{{ request.locale.iso_code }}">
  <head>
    {%- comment -%} Critical metas below here {% endcomment %}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    {%- comment -%} Title {% endcomment %}
    <title>
      {{- page_title -}}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {%- comment -%} Preconnect links below here {% endcomment %}
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    {% unless settings.type_header_font.system? and settings.base_font.system? -%}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    {% endunless -%}

    {%- comment -%} DNS prefetch for third-party domains {%- endcomment -%}
    <link rel="dns-prefetch" href="https://judge.me">
    <link rel="dns-prefetch" href="https://cdn.judge.me">
    {%- if template.name == 'collection' or template.name == 'search' -%}
      <link rel="dns-prefetch" href="https://globo.productfiltersearch.com">
    {%- endif -%}

    {%- comment -%} Asynchronous JS below here {%- endcomment -%}

    {%- comment -%} CSS that includes @import below here {%- endcomment -%}

    {%- comment -%} Synchronous JS and CSS below here {% endcomment %}
    {%- comment -%} All CSS variables needed for the site {%- endcomment -%}
    {% render 'css-settings-and-variables' %}

    {%- comment -%} Critical CSS - Load immediately with render-blocking (required for initial render) {%- endcomment -%}
    {{ 'accessibility.css' | asset_url | stylesheet_tag }}
    {{ 'reset.css' | asset_url | stylesheet_tag }}
    {{ 'critical.css' | asset_url | stylesheet_tag }}

    {%- comment -%} Template-specific critical CSS {% endcomment %}
    {% if template.name == 'product' -%}
      {{ 'template-product.css' | asset_url | stylesheet_tag }}
    {% elsif template.name == 'collection' or template.name == 'search' -%}
      {{ 'component-product-grid.css' | asset_url | stylesheet_tag }}
    {% endif -%}

    {{ 'component-grid.css' | asset_url | stylesheet_tag }}
    {{ 'component-card.css' | asset_url | stylesheet_tag }}
    {{ 'component-gridy-slider.css' | asset_url | stylesheet_tag }}

    {%- comment -%} Defer non-critical CSS {% endcomment %}
    <link rel="stylesheet" href="{{ 'non-critical-variables.css' | asset_url }}" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="{{ 'custom.css' | asset_url }}" media="print" onload="this.media='all'">

    {% if settings.product_card_show_rating -%}
      <link rel="stylesheet" href="{{ 'component-rating.css' | asset_url }}" media="print" onload="this.media='all'">
    {% endif -%}

    {%- comment -%} Preload links below here {% endcomment %}
    {% # theme-check-disable %}
    {%- comment -%} Only preload fonts that are critical for above-the-fold content {%- endcomment -%}
    {% unless settings.base_font.system? -%}
      <link rel="preload" as="font" fetchpriority="high" href="{{ settings.base_font | font_url }}" type="font/woff2" crossorigin>
    {% endunless -%}
    {%- comment -%} Header font gets lower priority - usually below fold or less text {%- endcomment -%}
    {% unless settings.header_font.system? -%}
      <link rel="preload" as="font" href="{{ settings.header_font | font_url }}" type="font/woff2" crossorigin>
    {% endunless -%}
    {% if settings.css_animations -%}
      <link rel="preload" as="style" fetchpriority="low" href="{{ 'animations.css' | asset_url }}" onload="this.rel='stylesheet'">
    {% endif -%}

    {% if settings.product_card_quick_buy -%}
      <link rel="stylesheet" fetchpriority="low" media="print" href="{{ 'component-modals.css' | asset_url }}" onload="this.media='all'">
    {% endif -%}
    {% if settings.product_card_quick_buy or template.name == 'product' -%}
      {%- if template.name == 'product' -%}
        <link rel="preload" as="style" fetchpriority="low" href="{{ 'component-product-form.css' | asset_url }}" onload="this.rel='stylesheet'">
        {%- else -%}
        <link rel="stylesheet" fetchpriority="low" media="print" href="{{ 'component-product-form.css' | asset_url }}" onload="this.media='all'">
      {%- endif -%}
    {% endif %}
    {%- comment -%} Preload LCP images for faster rendering {%- endcomment -%}
    {% if template.name == 'product' and product.featured_image != empty -%}
      <link rel="preload" as="image" href="{{ product.featured_image | image_url: width: 800 }}" media="(min-width: 768px)" fetchpriority="high">
      <link rel="preload" as="image" href="{{ product.featured_image | image_url: width: 600 }}" media="(max-width: 767px)" fetchpriority="high">
    {% elsif template.name == 'index' -%}
      {%- comment -%} Homepage hero preload removed: file_img_url creates URL mismatch causing "preload not used" warnings {%- endcomment -%}
      {%- comment -%} Hero image still loads with fetchpriority="high" attribute for fast loading {%- endcomment -%}
    {% elsif template.name == 'collection' and collection.image != blank -%}
      <link rel="preload" as="image" href="{{ collection.image | image_url: width: 1200 }}" media="(min-width: 768px)" fetchpriority="high">
    {% endif %}
    {% if template.name != 'cart' -%}
      <link rel="stylesheet" href="{{ 'component-cart.css' | asset_url }}" media="print" onload="this.media='all'">
    {% endif %}
    {% # theme-check-enable %}
    <noscript>
    {{ 'non-critical-variables.css' | asset_url | stylesheet_tag }}
    {{ 'custom.css' | asset_url | stylesheet_tag }}
    {% if settings.css_animations -%}
      {{ 'animations.css' | asset_url | stylesheet_tag }}
    {% endif -%}
    {% if settings.product_card_show_rating -%}
      {{ 'component-rating.css' | asset_url | stylesheet_tag }}
    {% endif -%}
    {% if settings.product_card_quick_buy -%}
      {{ 'component-modals.css' | asset_url | stylesheet_tag }}
    {% endif -%}
    {% if settings.product_card_quick_buy or template.name == 'product' -%}
     {{ 'component-product-form.css' | asset_url | stylesheet_tag }}
    {% endif -%}
    {% if template.name != 'cart' -%}
      {{ 'component-cart.css' | asset_url | stylesheet_tag }}
    {% endif -%}
    </noscript>

    {%- comment -%} Shopify's content_for_header - moved before scripts for optimal loading {%- endcomment -%}
    {{ content_for_header }}

    {% comment -%} Deferred JS below here {% endcomment %}
    <script type="text/javascript" src="{{ 'global.js' | asset_url }}" defer></script>
    <script type="text/javascript" src="{{ 'lazy-app-blocks.js' | asset_url }}" defer></script>
    <script type="text/javascript" data-loading="lazy" data-src="{{ 'component-predictive-search.js' | asset_url }}"></script>
    {% if settings.product_card_quick_buy -%}
      <script type="text/javascript" data-loading="lazy" data-src="{{ 'component-quick-buy.js' | asset_url }}"></script>
    {% endif -%}
    {% if template.name == 'product' -%}
      <script type="text/javascript" src="{{ 'component-product-form.js' | asset_url }}" defer></script>
      {%- comment -%} Lazy load Judge.me reviews for better performance {%- endcomment -%}
      <script type="text/javascript" src="{{ 'lazy-judgeme.js' | asset_url }}" defer></script>
      {%- comment -%} Lazy load product carousels (Best Sellers, Trending, etc.) {%- endcomment -%}
      <script type="text/javascript" src="{{ 'lazy-carousels.js' | asset_url }}" defer></script>
      {%- comment -%} Klaviyo product tracking (externalized from inline script) {%- endcomment -%}
      <script type="text/javascript" src="{{ 'klaviyo-product-tracking.js' | asset_url }}" defer></script>
    {% elsif settings.product_card_quick_buy -%}
      <script type="text/javascript" data-loading="lazy" data-src="{{ 'component-product-form.js' | asset_url }}"></script>
    {% endif -%}
    <script type="text/javascript" src="{{ 'component-animations.js' | asset_url }}" defer></script>

    {%- comment -%} Everything else, e.g. SEO metas etc. below here {% endcomment %}
    {% if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif -%}
    <link rel="canonical" href="{{ canonical_url }}">

    {%- render 'meta-tags' %}

    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
    </script>

    <meta name="theme-color" content="">
    {% if settings.favicon != blank -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 32, height: 32 }}" type="image/png" />
    {% endif -%}
    {% if settings.head_custom_liquid != blank -%}
      {{ settings.head_custom_liquid }}
    {% endif %}
    {%- comment -%}
    Image optimization is now handled server-side via Shopify's image_url filter
    with proper sizing parameters. This improves LCP and prevents layout shifts.
    {%- endcomment -%}
  </head>

  <body class="woolman template-{{ template.name }} {{ template.suffix }} country-{{ localization.country | handleize }} language-{{  request.locale.iso_code }}">
    
    <a class="skip-to-content-link visually-hidden" href="#MainContent">
      {{ "accessibility.skip_to_text" | t }}
    </a>

    {%- sections 'header-group' -%}

    <main id="MainContent" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>

    {%- sections 'aside-group' -%}
    {%- sections 'footer-group' -%}

    {%- if settings.cart_type == 'notification' -%}
      {% render 'cart-notification' %}
    {%- endif -%}

    <ul hidden>
      <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
    </ul>

    <script>
      window.shopUrl = '{{ shop.url }}';
      window.routes = {
        root: '{{ routes.root_url }}',
        cart_url: '{{ routes.cart_url }}',
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        search_url: '{{ routes.search_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}',
        product_recommendations_url: '{{ routes.product_recommendations_url }}',
      };

      window.cartStrings = {
        error: `{{ 'sections.cart.cart_error' | t }}`,
        quantityError: `{{ 'sections.cart.cart_quantity_error_html' | t: quantity: '[quantity]' }}`,
        shipping_free: `{{ 'sections.cart.shipping_free' | t }}`,
        shipping_not_free: `{{ 'sections.cart.shipping_not_free' | t: amount: '[amount]' }}`,
      };

      window.variantStrings = {
        addToCart: `{{ 'products.product.add_to_cart' | t }}`,
        itemAdded: `{{ 'general.cart.item_added' | t }}`,
        itemsAdded: `{{ 'general.cart.items_added' | t }}`,
        soldOut: `{{ 'products.product.sold_out' | t }}`,
        preOrder: `{{ 'products.product.preorder.preorder' | t }}`,
        unavailable: `{{ 'products.product.unavailable' | t }}`,
        unavailable_with_option: `{{ 'products.product.value_unavailable' | t: option_value: '[value]' }}`,
        inventory: {
          in_stock: `{{ 'products.product.inventory.in_stock' | t }}`,
          in_stock_with_quantity: `{{ 'products.product.inventory.in_stock_with_quantity' | t: quantity: '[quantity]' }}`,
          few_left: `{{ 'products.product.inventory.few_left' | t }}`,
          few_left_with_quantity: `{{ 'products.product.inventory.few_left_with_quantity' | t: quantity: '[quantity]' }}`,
          will_be_in_stock_after: `{{ 'products.product.inventory.will_be_in_stock_after' | t: date: '[date]' }}`,
          waiting_for_stock: `{{ 'products.product.inventory.waiting_for_stock' | t }}`,
          out_of_stock: `{{ 'products.product.inventory.out_of_stock' | t }}`,
          out_of_stock_continue_selling: `{{ 'products.product.inventory.out_of_stock_continue_selling' | t }}`,
        },
      };

      window.accessibilityStrings = {
        imageAvailable: `{{ 'products.product.media.image_available' | t: index: '[index]' }}`,
        shareSuccess: `{{ 'general.share.success_message' | t }}`,
        pauseSlideshow: `{{ 'sections.slideshow.pause_slideshow' | t }}`,
        playSlideshow: `{{ 'sections.slideshow.play_slideshow' | t }}`,
      };

      window.themeStrings = {
        product_count_simple_one: `{{ 'products.facets.product_count_simple.one' | t: count: '[count]' }}`,
        product_count_simple_other: `{{ 'products.facets.product_count_simple.other' | t: count: '[count]' }}`,
        results_with_count_one: `{{ 'templates.search.results_with_count.one' | t: count: '[count]' }}`,
        results_with_count_other: `{{ 'templates.search.results_with_count.other' | t: count: '[count]' }}`,
      };

      theme = {};
      theme.settings = {
        moneyFormat: {{ shop.money_format | json }},
      };

      theme.assets = {};
    </script>

    <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0">
      <defs>
        <clipPath id="circle-substract">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M24 15.373C18.7775 13.6859 15 8.78408 15 3C15 1.96746 15.1204 0.963039 15.3479 0L0 0V24H24V15.373Z" fill="black"/>
        </clipPath>
      </defs>
    </svg>

    <script type="text/javascript" fetchpriority="low" src="{{ 'script-loader.js' | asset_url }}" defer></script>

    {%- if settings.body_custom_liquid != blank -%}
      {{ settings.body_custom_liquid }}
    {%- endif -%}
  {%- comment -%} Deferred Globo Filter template loading - Load templates when user needs them {%- endcomment -%}
  {%- if template.name == 'collection' or template.name == 'search' -%}
    {%- comment -%} Capture all templates in JavaScript strings for deferred injection {%- endcomment -%}
    {%- capture productTemplate -%}{% render 'globo.filter.product', themeTranslation: shop.metafields.globoFilter.themeTranslation.value[request.locale.iso_code] %}{%- endcapture -%}
    {%- capture treeTemplate -%}{% render 'globo.filter.tree' %}{%- endcapture -%}
    {%- capture sortTemplate -%}{% render 'globo.filter.sort' %}{%- endcapture -%}
    {%- capture searchTemplate -%}{% render 'globo.filter.search' %}{%- endcapture -%}
    {%- capture paginationTemplate -%}{% render 'globo.filter.pagination' %}{%- endcapture -%}
    {%- capture YMMTemplate -%}{% render 'globo.filter.form' %}{%- endcapture -%}

    <script>
      // Deferred Globo Filter Template Loader - Optimized for performance & localization
      (function() {
        let globoTemplatesLoaded = false;

        // Store templates as strings (preserves translations)
        const globoTemplates = {
          gspfProduct: {{ productTemplate | replace: "script>", "scripttag>" | json }},
          gspfFilterTree: {{ treeTemplate | replace: "script>", "scripttag>" | json }},
          gspfFilterSort: {{ sortTemplate | replace: "script>", "scripttag>" | json }},
          gspfSearchResult: {{ searchTemplate | replace: "script>", "scripttag>" | json }},
          gspfPagination: {{ paginationTemplate | replace: "script>", "scripttag>" | json }},
          gspfForm: {{ YMMTemplate | replace: "script>", "scripttag>" | json }}
        };

        function loadGloboTemplates() {
          if (globoTemplatesLoaded) return;
          globoTemplatesLoaded = true;

          // Inject all templates into DOM
          Object.keys(globoTemplates).forEach(function(id) {
            if (globoTemplates[id] && !globoTemplates[id].includes('Liquid error')) {
              const script = document.createElement('script');
              script.id = id;
              script.type = 'template/html';
              script.textContent = globoTemplates[id];
              document.body.appendChild(script);
            }
          });

          // Trigger Globo re-initialization if needed
          if (window.GlobalFiltering && window.GlobalFiltering.init) {
            window.GlobalFiltering.init();
          }
        }

        // Strategy 1: Load when page is idle (best for performance)
        if ('requestIdleCallback' in window) {
          requestIdleCallback(loadGloboTemplates, { timeout: 2000 });
        } else {
          // Fallback: Load after 1 second
          setTimeout(loadGloboTemplates, 1000);
        }

        // Strategy 2: Load immediately if filter button clicked (backup)
        document.addEventListener('click', function(e) {
          if (e.target.closest('.filter-toggle, [data-filter-open], .globo-filter-button, .gf-filter-trigger')) {
            loadGloboTemplates();
          }
        }, true);

        // Strategy 3: Load when scrolling near products (backup)
        const observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              loadGloboTemplates();
              observer.disconnect();
            }
          });
        }, { rootMargin: '300px' });

        // Observe product grid or filter container
        document.addEventListener('DOMContentLoaded', function() {
          const targets = document.querySelectorAll('.product-grid, .collection-grid, [data-globo-filter], .gf-filter-container');
          targets.forEach(function(target) {
            if (target) observer.observe(target);
          });
        });
      })();
    </script>
  {%- endif -%}
<script>
window.preventScrollToProduct = true;
</script>
{% # ADMIN ONLY VIEW START # %}
<script>document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("PBarNextFrameWrapper"),n=document.querySelectorAll("admin");e?(document.body.classList.add("admin"),n.forEach(function(e){e.style.display="block"})):n.forEach(function(e){e.remove()})})</script><style>admin{display:none}</style>{% if request.design_mode %}<style>admin{display:block}</style>{% endif %}
{% # ADMIN ONLY VIEW END# %}

  {%- comment -%} Defer Trustpilot widget loading for better performance {%- endcomment -%}
  <script src="{{ 'lazy-trustpilot.js' | asset_url }}" defer></script>

  </body>
</html>